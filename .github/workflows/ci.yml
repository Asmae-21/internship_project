name: CI - Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Verify init-mongo.js exists
      run: |
        if [ -f init-mongo.js ]; then
          echo "✅ init-mongo.js found"
          head -5 init-mongo.js
        else
          echo "❌ init-mongo.js not found!"
          exit 1
        fi
    
    - name: Build and start all services
      run: docker compose up -d --build
    
    - name: Wait for MongoDB to initialize
      run: sleep 30
    
    - name: Check running containers
      run: docker compose ps
    
    - name: Verify MongoDB initialization
      run: |
        echo "Checking MongoDB collections..."
        docker exec auth-service-mongo mongosh \
          -u admin \
          -p securepassword123 \
          --authenticationDatabase admin \
          auth-service \
          --eval "db.getCollectionNames()" || echo "MongoDB check skipped"
      continue-on-error: true
    
    - name: Check test users were created
      run: |
        echo "Checking test users..."
        docker exec auth-service-mongo mongosh \
          -u admin \
          -p securepassword123 \
          --authenticationDatabase admin \
          auth-service \
          --eval "db.users.countDocuments()" || echo "User count check skipped"
      continue-on-error: true
    
    - name: Test backend health
      run: |
        for i in {1..10}; do
          if curl -f http://localhost:4000/health 2>/dev/null || curl -f http://localhost:4000/ 2>/dev/null; then
            echo "✅ Backend is responding"
            exit 0
          fi
          echo "Waiting for backend... ($i/10)"
          sleep 3
        done
        echo "⚠️ Backend health check timed out"
      continue-on-error: true
    
    - name: Test frontend is running
      run: |
        for i in {1..10}; do
          if curl -f http://localhost:3000 2>/dev/null; then
            echo "✅ Frontend is responding"
            exit 0
          fi
          echo "Waiting for frontend... ($i/10)"
          sleep 3
        done
        echo "⚠️ Frontend health check timed out"
      continue-on-error: true
    
    - name: Show logs if failed
      if: failure()
      run: |
        echo "════════════════════════════════════════"
        echo "MongoDB Logs"
        echo "════════════════════════════════════════"
        docker compose logs mongo
        echo ""
        echo "════════════════════════════════════════"
        echo "Backend Logs"
        echo "════════════════════════════════════════"
        docker compose logs backend
        echo ""
        echo "════════════════════════════════════════"
        echo "Frontend Logs"
        echo "════════════════════════════════════════"
        docker compose logs frontend
    
    - name: Cleanup
      if: always()
      run: docker compose down -v
